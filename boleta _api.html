<!DOCTYPE html>
<html lang="en">
 <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
     <!-- Bootstrap CSS -->
     <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" integrity="sha384-zCbKRCUGaJDkqS1kPbPd7TveP5iyJE0EjAuZQTgFLD2ylzuqKfdKlfG/eSrtxUkn" crossorigin="anonymous">

     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
     <!--- Mis estilos -->
     <link rel="stylesheet" href="assets/css/style.css">
    
      
    </head>
 <body>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js" integrity="sha384-VHvPCCyXqtD5DqJeNxl2dtTyhF78xXNXdkwX1CZeRusQfRKp+tA7hAShOK/B/fQ2" crossorigin="anonymous"></script>
  
    
	<div class="container">
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb">
			  <li class="breadcrumb-item active" aria-current="page">SECCIÓN BOLETA - CONFIRME SU PEDIDO</li>
		      <li class="breadcrumb-item active" aria-current="page">si desea regresar al carro presione el botón VOLVER</li>		
			  
			</ol>
		  </nav>
		<div class ="section">			
			<a class="btn btn-success" href="index_carrito.html" align="left">VOLVER</a>
		</div>
		
	</div>
    
    <div class="row mt-4">
      <div class="col-sm-12">
        <div class="card" style="height: 100%;">
          <div class="card-body">
            <h5 class="card-title">datos cliente
            
            </h5>
            <div class="table-responsive">
              <table class="table" id="datos">
                <thead class="thead-dark">
                  
                  <tr>
                    
                    <th scope="col"><small>Primer nombre</small></th>
                    <th scope="col"><small>Apellido paterno</small></th>
                    <th scope="col"><small>Apellido materno</small></th>
                    <th scope="col"><small>Direccion</small></th>
                    <th scope="col"><small>Comuna</small></th>
                    <th scope="col"><small>Correo</small></th>
                    
                    
                  </small>  
                  </tr> 
                </thead>

                <tbody>
                  <tr>
                    <td scope="col"><small>Primer nombre</small></td>
                    <td scope="col">apellido_paterno</td>
                    <td scope="col">apellido_materno</td>
                    <td scope="col">direccion</td>
                    <td scope="col">comuna</td>
                    <td scope="col">correo</td>
                    
                    
                  </tr> 
                  
                </tbody>
              </table>
            </div>
          </div>  
        </div> 
      </div>
    </div>
    
    <div class="row mt-4">
      <div class="col-sm-12">
        <div class="card" style="height: 100%;">
          <div class="card-body">
            <h5 class="card-title">boleta
            </h5>
            <div class="table-responsive">
              <table class="table" id="boleta">
                <thead class="thead-dark">
                  <tr>
                    <th scope="col">n° productos</th>
                    <th scope="col">codigo</th>
                    <th scope="col">nombre</th>
                    <th scope="col">descripcion</th>
                    <th scope="col">valor_venta</th>
                    <th scope="col">cantidad</th>
                    
                    
                    
                  </tr>
                </thead>
                

                <tbody>
                  <tr>
                    <th scope="row"></th>
                    
                    <td>codigo</td>
                    <td>nombre</td>
                    <td>valor_venta</td>
                    <td>stock</td>
                    <td>descripcion</td>
                    
                    
                  </tr> 
                  
                </tbody>
              </table>
            </div>
          </div>  
        </div> 
      </div>
    </div>
    




    <div class="row mt-4">
      <div class="col-sm-12">
        <div class="card" style="height: 100%;">
          <div class="card-body">
            <h5 class="card-title">total
            </h5>
            <div class="table-responsive">
              <table class="table" id="total">
                <thead class="thead-dark">


                  
                  <tr>
                    <th scope="col">total productos</th>
                    <th scope="col">total neto</th>
                    <th scope="col">total iva</th>
                    <th scope="col">total a pagar</th>
                    
                  </tr>
                </thead>
                                        

                <tbody id = "detalleTotal">
                  <tr>
                    
                    <td scope="col">cantidad</td>
                    <td scope="col">valor_venta</td>
                    <td scope="col">iva</td>
                    <td scope="col">total a pagar</td>
                   
                  </tr>
                  
                </tbody>
              </table>
            </div>
          </div>  
        </div> 
      </div>
    </div>

	<div class="container">
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb">
			  <li class="breadcrumb-item active" aria-current="page">CONFIRME SU PEDIDO</li>
		      <li class="breadcrumb-item active" aria-current="page">Presione el boton para confirmar la compra</li>		
			  
			</ol>
		</nav>
		  <a class="btn btn-success" id="confirmaCompra" href="formulario-despacho.html" align="right">CONFIRMAR COMPRA</a>
		
	</div>

  <!--- script-->
   
    <script>
     
      const API_URL = 'http://127.0.0.1:5000/';
        
      $(document).ready(function(){
        $('#boleta tbody , #datos tbody , #total tbody').empty();
        actualizarTabla()
        actualizarTotal()
        actualizarCliente()
        
      })

      // Tabla productos
      function actualizarTabla(){
          $('boleta tbody').empty();
  
          $.ajax({
            url: API_URL+'producto_car',
            type: 'GET',
            dataType: 'json',
            success: function(respuesta){
            //console.log(respuesta);
              
              for (var i = 0; i < respuesta.length; i++){
                 
                 var fila = '<tr>' +
                    '<th scope="col"><small>'  + (i+1) + '</small></th>' +
                    '<td ><small>'+ respuesta[i].codigo + '</small></td>' +
                    '<td><small>' + respuesta[i].nombre + '</small></td>' +
                    '<td><small>' + respuesta[i].descripcion + '</small></td>' +
                    '<td><small>' + respuesta[i].valor_venta + '</small></td>' +
                    '<td><small>' + respuesta[i].stock + '</small></td>' +
                    '</tr>';                 
                  
  
                 $('#boleta').append(fila);
              }
              
            }
          })
  
        }
        document.querySelector('#total tbody').addEventListener('blur', actualizarTotal);
        function actualizarTotal(){
          const xhttp = new XMLHttpRequest();
          xhttp.open('GET', API_URL+'producto_car', true);
          xhttp.send();
          xhttp.onreadystatechange = function(){
            if (this.readyState == 4 && this.status == 200){
               let datos = JSON.parse(this.responseText);
               //console.log(datos);
			   let res = document.querySelector('#total tbody');
               res.innerHTML = '';
			   var largo = datos.length;
			   var total_neto = 0;
               var total_iva = 0;
               var total_a_pagar = 0;
			   var total_productos = 0;
			   total_productos = largo;
			   for (let i = 0; i < largo; i++){
					total_neto += datos[i].valor_venta * datos[i].stock;
					total_iva += total_neto * 0.19;
					total_a_pagar = total_neto + total_iva;
				}
				console.log(total_a_pagar);
				res.innerHTML += `
				<tr>
                    
                    <td scope="col">${total_productos}</td>
                    <td scope="col">$ ${total_neto}</td>
                    <td scope="col">$ ${total_iva}</td>
                    <td scope="col">$ ${total_a_pagar}</td>
                   
                  </tr>
				`;
			               
              
          }
        }
	}
                 
	  
        // Función patra buscafr la comuna y mostrarla, pero no resulta :/
        document.querySelector('#datos tbody').addEventListener('blur', buscarComuna);
        function buscarComuna(comu){
          const xhttp = new XMLHttpRequest();
          xhttp.open('GET', API_URL+'comuna/'+comu, true);
		  xhttp.responseType = 'text';
          xhttp.send();
          xhttp.onreadystatechange = function() {
			
            if (this.readyState == 4 && this.status == 200) {
               let comuna = JSON.parse(this.responseText);
               console.log(comuna);
			   //comuna = JSON.stringify(comuna);
			    
			   return `${comuna['Nombre']}`;
			 
			  
                        
                            
            }
			
          }  
                    
        }
        // Función para buscar el cliente y mostrarlo

        document.querySelector('#datos tbody').addEventListener('blur', actualizarCliente);
        function actualizarCliente(){
          //$('datos tbody').empty();
          const xhttp = new XMLHttpRequest();
          xhttp.open('GET', API_URL+'usuario_car', true);
          xhttp.send();
          xhttp.onreadystatechange = function(){

              //console.log(respuesta);
              if (this.readyState == 4 && this.status == 200){
                //console.log(this.responseText);
                let datos = JSON.parse(this.responseText);
                //console.log(datos);
                let res = document.querySelector('#datos tbody');
                res.innerHTML = '';
                for (let item of datos){
                  res.innerHTML += `
                  <tr>
                    <td scope="col"><small>${item.primer_nombre}</small></td>
                    <td scope="col"><small>${item.apellido_paterno}</small></td>
                    <td scope="col"><small>${item.apellido_materno}</small></td>
                    <td scope="col"><small>${item.direccion}</small></td>
                    <td scope="col"><small>${item.comuna}</small></td>
                    <td scope="col"><small>${item.correo}</small></td>
                                        
                  </tr>`
                }
              }
              
              
              
            }
          }
        
        

        
    </script>
   
  </body> 
  

</html>